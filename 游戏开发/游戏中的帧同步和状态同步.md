### 游戏中的帧同步和状态同步

---

#### (一)同步

同步，就是要多个客户端的表现效果是一致的。

例如我们玩王者荣耀的时候，需要十个玩家的屏幕显示的英雄位置完全相同、技能释放角度、释放时间完全相同，这个就是同步。而对于大多数游戏，不仅客户端的表现要一致，而且需要客户端和服务端的数据是一致的。所以，同步是一个网络游戏概念，只有网络游戏才需要同步，而单机游戏是不需要同步的。

#### (二)状态同步和帧同步的区别

最大的区别就是**战斗核心逻辑**写在哪，状态同步的战斗逻辑在服务端，帧同步的战斗逻辑在客户端。

战斗逻辑：包括技能逻辑、普攻、属性、伤害、移动、AI、检测、碰撞等等的一系列内容，这常常也被视为游戏开发过程中最难的部分。

由于核心逻辑必须知道一个场景中的所有实体情况，所以MMO游戏（例如魔兽世界）就必须把战斗逻辑写在服务端，所以**MMO游戏必须是状态同步的**，因为MMO游戏的客户端承载有限，并不能把整张地图的实体全部展现出来（例如100米以外的NPC和玩家就不显示了），所以客户端没有足够的信息计算全图的人的所有行为。

具体到客户端和服务端通信上，**在状态同步下，客户端更像是一个服务端数据的表现层，**举个例子，一个英雄的几乎所有属性（例如血量、攻击、防御、攻速、魔法值等等）都是服务端传给客户端的，而且在属性发生改变的时候，服务端需要实时告诉客户端哪些属性改变了，客户端并不能改变这些属性，而是服务端传来多少属性就显示多少属性（虽然可以改变客户端数值达到表现上的效果，例如无限血量，但是服务端那边的血量属性为0时，一样要死）。

再举个例子，一个英雄要释放一个非指向性技能（例如伊泽瑞尔的Q），具体的过程就是，客户端通知服务端“我要释放一个技能”-》服务端通知客户端“在某地以什么方向释放某技能”-》客户端根据这些信息创建一个特效放在某地，然后以某个方向飞行-》服务端根据碰撞检测逻辑判断到某个时刻，这个技能碰到了敌方英雄，通知客户端-》客户端根据服务端信息，删除特效，被打的英雄减血同时播放受击特效。

而在帧同步下，通信就比较简单了，**服务端只转发操作，不做任何逻辑处理**。以下图为例：

![截屏2020-11-12 下午11.54.09](https://tva1.sinaimg.cn/large/0081Kckwgy1gkmtub8f62j30ya0hstg0.jpg)

现在同一局里有4个玩家，也就是4个客户端，这时客户端A释放了一个技能x，此时将操作传递给服务端，服务端不做任何判断，直接把A的操作全部分发给ABCD，则ABCD同时让客户端A控制的英雄释放技能x。

#### (三)流量

**状态同步比帧同步流量消耗大**，例如一个复杂游戏的英雄属性可能有100多条，每次改变都要同步一次属性，这个消耗是巨大的，而帧同步不需要同步属性；例如释放一个技能，服务端需要通知客户端很多条消息（必须是分步的，不然功能做不了），而帧同步就只需要转发一次操作就行了。



#### (四)回放&观战

帧同步的回放&观战比状态同步好做得多，因为只需要保存每局所有人的操作就好了，而状态同步的回放&观战，需要有一个回放&观战服务器，当一局战斗打响，战斗服务器在给客户端发送消息的同时，还需要把这些消息发给放&观战服务器，回放&观战服务器做储存，如果有其他客户端请求回放或者观战，则回放&观战服务器把储存起来的消息按时间发给客户端。

#### (五)安全性

状态同步的安全性比帧同步高很多，因为状态同步的所有逻辑和数值都是在服务端的，如果想作弊，就必须攻击服务器，而攻击服务器的难度比更改自己客户端数据的难度高得多，而且更容易被追踪，被追踪到了还会有极高的法律风险。而帧同步因为所有数据全部在客户端，所以解析客户端的数据之后，就可以轻松达到自己想要的效果，例如moba类游戏的全图挂，吃鸡游戏的透视挂，都是没办法防止的，而更改数据达到胜利的作弊方式（例如更改自己的英雄攻击力）**可以通过服务器比对同局其他人的战斗结果来预防。**



#### (六)断线重连

状态同步的断线重连很好做，无非就是把整个场景和人物全部重新生成一遍，各种数值根据服务端提供加到人物身上而已。帧同步的断线重连就比较麻烦了，例如客户端在战场开始的第10秒短线了，第15秒连回来了，就需要服务端把第10秒到第15秒之间5秒内的所有消息一次性发给客户端，然后客户端**加速整个游戏的核心逻辑运行速度**（例如加速成10倍），直到追上现有进度。



#### (七)开发效率

状态同步的游戏开发起来比较难，但是状态同步的游戏仍然是游戏的主流。帧同步服务器开发难度低，同一套方案可以给很多不同类型的游戏使用，反正都是转发操作，减少了服务端客户端沟通。



状态同步的方案下，同一个功能至少需要一个客户端和服务端共同完成，PVP和PVE基本用的是同一套代码，做完PVP很容易就可以做单机的PVE。



---

疑问：

1. 采用帧同步的话服务端的角色仅仅只是校验数据和转发数据吗？

2. 在一个具体的实例下：

   如果一个游戏类似球球大作战，玩家在一个平面地图上进行对战，对战的实时性要求较高，属于那种直接定胜负的类型，地图非常的大，可以同时容纳上百人，玩家的客户端是无法一次性加载那么大的地图的，这个时候采用的同步机制是采用帧同步or状态同步还是两种都混合呢？以及服务端所担任的角色在这里又是什么？(因为玩家的地图信息是服务端发送给玩家的)

   自问自答：个人理解同步机制主要是针对战斗逻辑而言的，而地图信息获取可以单独作为一项进程，独立于战斗逻辑进程的。

3. 预演和帧锁

参考资料：

[两种同步模式：状态同步和帧同步](https://zhuanlan.zhihu.com/p/36884005)