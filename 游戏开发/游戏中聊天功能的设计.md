### 游戏中聊天功能的设计

---

游戏中的聊天可以根据聊天对象的不同划分为如下几种业务类型：

1. 世界喊话
2. 私聊
3. 小队频道
4. 本地(local area)聊天

**(一) 世界喊话**

世界聊天有一个特点---发送给所有人，所以这里是需要用广播技术，类似聊天室一样，简单的聊天室的原理即将消息**广播**给聊天室内的所有人，对于游戏来说，要实现世界喊话需要维护一张全局用户表，将用户的消息进行广播即可



**(二)私聊**

p2p聊天，该聊天的特性是有明确的聊天对象，服务器只需要将特定的消息发送给特定的玩家即可



**(三)小队频道**

小队聊天和世界喊话的不同的地方是小队聊天的频道中只有小队中的玩家，因此服务器在对消息进行广播的时候需要选定特定的玩家来进行广播

想要实现上述功能，服务器要可以动态地创建出**消息容器**，当两个人完成组队的时候，我们可以用队伍的ID来充当队伍频道的标识符，在发送小队消息的时候，只需要带上频道ID为队伍ID就可以了。

**InBox**

为了让不同种类的消息传递更加井然有序，需要为信息的传递设计一种工作方式，如下图所示：

![截屏2020-11-09 上午11.25.43](https://tva1.sinaimg.cn/large/0081Kckwgy1gkircnpqehj30m80eotbs.jpg)

 喊话的玩家把喊话的消息发送到 公共聊天 InBox，公共聊天 Inbox 接到消息之后再把这个消息转发所有玩家。队伍聊天时把消息发送到自己的队伍 InBox 里，然后队伍的 InBox 在把消息转发到队伍里的玩家。

**(四)本地(local area)聊天**

玩家可以收到一定范围内的公共聊天，比较像是现实环境中所能听到的范围，离玩家距离比较远的人讲话玩家是无法听到的

<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkivg182fdj30gi0e6ac6.jpg" alt="截屏2020-11-09 下午1.47.20" style="zoom:50%;" />

当把本地聊天加入到Inbox架构中，每当进行转发的时候都进行filter做一下判断，如下图逻辑所示：

![截屏2020-11-09 下午1.50.09](https://tva1.sinaimg.cn/large/0081Kckwgy1gkivk1hxboj30na0eoaed.jpg)

但当在线玩家人数比较多的时候，例如当1000个玩家同时在线的时候，其中一个人说了一句话，是否需要计算这1000个玩家与讲话者的距离呢？这显然是不可取的，因为当讲话的人多了的时候，计算量无疑是十分庞大的，因此需要提出一些改进的措施。

这里采取了一种使用**空间换时间的策略**，假设地图是一个二维平面的，所有人都在这个二维平面网络上，将大的地图切分成许多个方格，根据玩家的坐标位置将玩家归类到某一个格子中，如下图所示

![截屏2020-11-09 下午1.56.31](https://tva1.sinaimg.cn/large/0081Kckwgy1gkivpk2u1xj30xc0eu41j.jpg)

接下来，我们为每个格子打上 ID 并为这个ID创建一个专属的地图频道。这样一来地图上的所有位置都对应的有一个唯一的地图区域聊天频道。

  现在只要把玩家发出的聊天消息发送到特定格子的频道里就OK了，其他玩家只管接收他所处的地图频道內聊天信息就可以了。

但是这种系统存在一个问题，如图所示

![截屏2020-11-09 下午5.45.17](https://tva1.sinaimg.cn/large/0081Kckwgy1gkj2bkixpij30py0a4my4.jpg)

红蓝两个点在两个格子的边缘，按照正常的逻辑他们两个应该是可以进行对话的，但是在上述逻辑下，他们两个是无法正常对话的，因此还需要加上玩家可以向周围几个格子发消息的功能。

![截屏2020-11-09 下午5.53.18](https://tva1.sinaimg.cn/large/0081Kckwgy1gkj2jyhnmvj30ge0fqjwd.jpg)

如果做得更精细一点可以将地图的格子设置的比较小，这样精度会更高，如下图所示

![截屏2020-11-09 下午5.53.55](https://tva1.sinaimg.cn/large/0081Kckwgy1gkj2kowbqvj30js0jikgs.jpg)

但随之而来的计算量也会变得很大，因此我们可以提前计算好每个格子周围的广播范围，将数据静态存储，每次服务器加载格子数据的时候，就不需要重复计算了，这样就可以避免庞大的计算量。

---

参考资料：

[聊一聊游戏服务器架构设计－聊天功能的那些事](https://my.oschina.net/ta8210/blog/709075)

